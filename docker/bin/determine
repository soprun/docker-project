#!/bin/sh

# https://github.com/openbridge/ob_php-fpm

# Determine the PHP-FPM runtime environment

CPU=$(grep -c ^processor /proc/cpuinfo)

echo "CPU: ${CPU}"

TOTAL_MEMORY=$(free -m | awk '/^Mem:/{print $2}')

echo "Total memory: ${TOTAL_MEMORY}"

if [[ "$CPU" -le "2" ]]; then
    TOTAL_CPU=2
else
    TOTAL_CPU="${CPU}"
fi

echo "Total CPU: ${TOTAL_CPU}"

# PHP-FPM settings
if [[ -z $PHP_START_SERVERS ]]; then
    PHP_START_SERVERS=$(($TOTAL_CPU / 2)) && echo "PHP Start servers: ${PHP_START_SERVERS}"
fi
if [[ -z $PHP_MIN_SPARE_SERVERS ]]; then
    PHP_MIN_SPARE_SERVERS=$(($TOTAL_CPU / 2)) && echo "php_min_spare_servers: ${PHP_MIN_SPARE_SERVERS}"
fi
if [[ -z $PHP_MAX_SPARE_SERVERS ]]; then
    PHP_MAX_SPARE_SERVERS="${TOTAL_CPU}" && echo "php_max_spare_servers: ${PHP_MAX_SPARE_SERVERS}"
fi
if [[ -z $PHP_MEMORY_LIMIT ]]; then
    PHP_MEMORY_LIMIT=$(($TOTAL_MEMORY / 2)) && echo "PHP Memory limit: ${PHP_MEMORY_LIMIT}"
fi
#if [[ -z $PHP_MAX_CHILDREN ]]; then PHP_MAX_CHILDREN=$(($TOTAL_CPU * 2)) && echo "${PHP_MAX_CHILDREN}"; fi
