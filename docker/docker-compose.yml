version: "3.4"

#volumes:
#  default:
#    driver: local

networks:
  frontend_tier:
    driver: bridge
  backend_tier:
    driver: bridge

x-logging:
  &default_logging
  logging:
    driver: "json-file"
    options:
      max-file: "5"
      max-size: "10m"

x-php:
  &default_php
  volumes:
    - ../src:/app:rw,consistent
  networks: [ backend_tier ]
  depends_on:
    - postgres
    - redis

services:
  nginx:
    build:
      dockerfile: ./docker/nginx/Dockerfile
      context: ..
    container_name: nginx
    <<: *default_logging
    ports: [ 80:80, 443:443 ]
    networks: [ frontend_tier, backend_tier ]
    depends_on:
      - php

  php:
    build:
      dockerfile: ./docker/php/Dockerfile
      context: ..
    container_name: app
    privileged: true
    <<: *default_logging
    <<: *default_php

  # php-workspace:
  # php-worker:

  postgres:
    image: postgres:13-alpine
    container_name: postgres
    hostname: "${POSTGRES_HOST}"
    environment:
      - POSTGRES_DB
      - POSTGRES_USERNAME
      - POSTGRES_PASSWORD
    ports: [ "${POSTGRES_PORT}" ]
    networks:
      - backend_tier

  redis:
    image: redis:6-alpine
    container_name: redis
    hostname: "${REDIS_HOST}"
    ports: [ "${REDIS_PORT}" ]
    networks:
      - backend_tier
