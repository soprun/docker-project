version: "3.4"

services:
  nginx:
    build:
      dockerfile: ./docker/nginx/Dockerfile
      context: .
    depends_on:
      - php
    ports: [ 80:80, 443:443 ]
    logging:
      driver: "$LOGGING_DRIVER"
      options:
        max-size: "$LOGGING_OPTIONS_MAX_SIZE"
        max-file: "$LOGGING_OPTIONS_MAX_FILE"

  php:
    build:
      dockerfile: ./docker/php/Dockerfile
      context: .
      target: development
    privileged: true
    volumes:
      - ./:/app:rw,consistent
      - ~/.composer/cache:/composer/cache:rw,cached
    depends_on:
      - database
      - redis
    logging:
      driver: "$LOGGING_DRIVER"
      options:
        max-size: "$LOGGING_OPTIONS_MAX_SIZE"
        max-file: "$LOGGING_OPTIONS_MAX_FILE"

  database:
    image: postgres:13-alpine
    restart: always
    environment:
      - POSTGRES_DB
      - POSTGRES_USERNAME
      - POSTGRES_PASSWORD
    ports: [ 5432 ]

  redis:
    image: redis:6-alpine
    restart: always
    ports: [ 6379 ]


# https://hub.docker.com/r/phpunit/phpunit/
# https://stfalcon.com/ru/blog/post/phpstorm-docker-code-coverage